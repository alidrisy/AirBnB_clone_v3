from flask import Flask, render_template, Response
import youtube_dl

app = Flask(__name__)

def generate_audio(video_id):
    ydl_opts = {
        'format': 'bestaudio/best', # get the best audio quality
        'postprocessors': [{
            'key': 'FFmpegExtractAudio', # use ffmpeg to extract audio
            'preferredcodec': 'mp3', # convert audio to mp3
            'preferredquality': '192', # audio quality = 192 Kbps
        }],
        'outtmpl': '/tmp/yt-audio-downloader/%(id)s.%(ext)s', # set the temporary output directory
        'quiet': True, # quiet mode to avoid displaying progress
    }

    with youtube_dl.YoutubeDL(ydl_opts) as ydl:
        ydl.download([f'https://www.youtube.com/watch?v={video_id}']) # download the video and convert it to audio
        for entry in ydl.extract_info(f'https://www.youtube.com/watch?v={video_id}', download=False): # get the info of the video
            file_path = entry['url'] # get the file path of the downloaded audio
            while True:
                try:
                    with open(file_path, 'rb') as f:
                        data = f.read(1024) # read the data from the file
                        while data:
                            yield data # send the data to the client
                            data = f.read(1024) # read the data from the file
                except FileNotFoundError:
                    continue
                except Exception as e:
                    print(f'Error: {e}')
                    break
                break

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/play/<video_id>')
def play(video_id):
    return Response(generate_audio(video_id), content_type='audio/mpeg')

if __name__ == '__main__':
    app.run(debug=True)
